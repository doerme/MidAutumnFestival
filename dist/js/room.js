/*!
 * @project : MidAutumnFestival
 * @version : 0.0.1
 * @author  : 
 * @update  : 2017-09-30 9:05:50 pm
 */!function(t){function n(e){if(o[e])return o[e].exports;var i=o[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var o={};return n.m=t,n.c=o,n.p="./js/",n(0)}([function(t,n,o){function e(t){return t&&t.__esModule?t:{"default":t}}var i=o(1),r=e(i);$(function(){var t={pageTpl:{roomunit:o(4)},buyNum:1,init:function(){var t=this;t.bindEvent(),t.inRoom();var n={url:"ws://ws.czcycm.com:9588",callback:function(n){"string"==typeof n&&(n=JSON.parse(n)),n.data&&n.data[0]&&t.talkUnitShow(n.data),console.log("ws cb",n)}};this.initSocket(n)},scrollBottom:function(){var t=$(".js-room-main-list")[0].scrollHeight||$(".js-room-main-list")[0].scrollHeight;$(".js-room-main-list").scrollTop(t)},talkUnitShow:function(t){var n=this,o=0;t&&t[0].delay&&(o=1e3*t[0].delay),console.log("delay",o),setTimeout(function(){$(".js-room-main-list").append(n.pageTpl.roomunit({data:t[0]})),setTimeout(function(){n.scrollBottom()},200),n.scrollBottom()},o)},inRoom:function(){var t=this;$.ajax({url:"http://www.czcycm.com/app/hb/jiaru_room",type:"post",data:{room_id:window.location.href.match(/roomid=(\d+)/)[1]}}).done(function(n){"string"==typeof n&&(n=JSON.parse(n)),1==n.code?($(".js-room-main-list").removeClass("hide"),t.getRoomMsg()):confirm("加入房间失败，请重试")&&window.history.back(-1),console.log(n)})},getRoomMsg:function(){var t=this;$.ajax({url:"http://www.czcycm.com/app/hb/my_info",type:"post"}).done(function(n){"string"==typeof n&&(n=JSON.parse(n)),1==n.code?($(".js-room-total-num").html(n.data.je),1==n.data.is_inroom?$(".bt-tuichu").removeClass("hide"):$(".bt-jiaru").removeClass("hide")):t.pageToast("获取个人信息失败"),console.log(n)})},sendIMMessage:function(){var t=this;return""==$.trim($(".js-main-input").val())?void t.pageToast("发送消息不能为空"):void $.ajax({url:"http://www.czcycm.com/app/hb/send_text",type:"post",data:{text:$(".js-main-input").val()}}).done(function(n){"string"==typeof n&&(n=JSON.parse(n)),1==n.code?($(".js-main-input").val(""),t.scrollBottom()):t.pageToast("消息发送失败请重试")})},roomTuichu:function(){var t=this;$.ajax({url:"http://www.czcycm.com/app/hb/tuichu_room",type:"post"}).done(function(n){"string"==typeof n&&(n=JSON.parse(n)),1==n.code?window.history.back(-1):t.pageToast("退出房间失败")}).fail(function(n){t.pageToast("退出房间失败")})},openRedPc:function(t,n,o){$(".js-redrp-open-avatar").attr({src:n}),$(".js-redrp-open-nickname").html(o),$.ajax({url:"http://www.czcycm.com/app/hb/hb_info/"+t,type:"post"}).done(function(t){"string"==typeof t&&(t=JSON.parse(t)),$(".toast-window-redpc").removeClass("null"),0==t.data.je&&$(".toast-window-redpc").addClass("null"),$(".js-redrp-open-msg").html(t.data.msg),$(".js-redrp-open").removeClass("hide"),$(".js-flrp-avatar").attr({src:n}),$(".js-flrp-name").html(o+"的红包"),$(".js-flrp-note").html(t.data.msg),$(".js-flrp-money").html(t.data.je+"<span>元</span>")})},bindEvent:function(){var t=this;$(".js-main-input").on("focus",function(){setTimeout(function(){document.body.scrollTop=document.body.scrollHeight,t.scrollBottom()},500)}),$(".js-emit-bt").on("click",function(){t.sendIMMessage()}),$(".bt-dating").on("click",function(){window.history.back(-1)}),$(".bt-jiaru").on("click",function(){t.inRoom()}),$(".bt-tuichu").on("click",function(){t.roomTuichu()}),$(".js-open-redpc").on("click",function(){$(".js-redrp-open").removeClass("hide")}),$(".toast-window-redpc").on("click",function(){$(".js-redrp-open").addClass("hide"),$(".js-redpc-rs").removeClass("hide")}),$(".toast-window-mask").on("click",function(){$(this).parent(".toast-window").addClass("hide")}),$(".twn-t-close, .js-win-close").on("click",function(){$(this).parents(".toast-window").addClass("hide")}),$(".rrw-close").on("click",function(){$(".js-redpc-rs").addClass("hide")}),$(".js-room-main-list").on("click",".js-open-redpc",function(){t.openRedPc($(this).data("id"),$(this).data("headimgurl"),$(this).data("nickname"))})},pageToast:function(t){$(".main-toast-window").html(t).removeClass("hide"),setTimeout(function(){$(".main-toast-window").addClass("hide")},1800)},initSocket:function(t){var n=window.location,o=t.url?t.url:"ws://"+n.hostname+":"+n.port+_get_basepath()+"/websocket",e=t.callback;if("function"!=typeof e)return console.log("callback 必须为函数"),!1;var i=new ReconnectingWebSocket(o);return i.onerror=function(){console.log("websocket.error")},i.onopen=function(t){console.log("onopen");var n={cmd:"login",gid:window.location.href.match(/roomid=(\d+)/)[1]};i.send((0,r["default"])(n))},i.onmessage=function(t){e(t.data)},i.onclose=function(){i.close(),console.log("websocket.onclose")},window.onbeforeunload=function(){i.close()},i}};t.init()})},function(t,n,o){t.exports={"default":o(2),__esModule:!0}},function(t,n,o){var e=o(3),i=e.JSON||(e.JSON={stringify:JSON.stringify});t.exports=function(t){return i.stringify.apply(i,arguments)}},function(t,n){var o=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=o)},function(t,n,o){var e=o(5);t.exports=e("/Users/xiaominghari/Documents/wanrenqun/MidAutumnFestival/MidAutumnFestival/src/js/tpl/roomunit",function(t,n){"use strict";var o=this,e=(o.$helpers,t.data),i=o.$escape,r="";return"text"==e.type?(r+=' <li> <img class="user-avatar" src="',r+=i(e.headimgurl),r+='" /> <div class="content-wrap"> <div class="user-name">',r+=i(e.nickname),r+='</div> <div class="user-msg">',r+=i(e.text),r+="</div> </div> </li> "):"hb"==e.type?(r+=' <li> <img class="user-avatar" src="',r+=i(e.headimgurl),r+='" /> <div class="content-wrap"> <div class="user-name">大安大厦</div> <div class="user-redpc js-open-redpc" data-id="',r+=i(e.hb_id),r+='" data-headimgurl="',r+=i(e.headimgurl),r+='" data-nickname="',r+=i(e.nickname),r+='"> <div class="ur-title">红包</div> <div class="ur-note">红包未领取</div> <div class="ur-bottom">微信红包</div> </div> </div> </li> '):"ts"==e.type&&(r+=' <li class="ts"><span class="ts-show">',r+=i(e.text),r+="</span></li> "),r+=" ",new String(r)})},function(t,n){!function(){function n(t,n){return(/string|function/.test(typeof n)?c:s)(t,n)}function o(t,n){return"string"!=typeof t&&(n=typeof t,"number"===n?t+="":t="function"===n?o(t.call(t)):""),t}function e(t){return p[t]}function i(t){return o(t).replace(/&(?![\w#]+;)|[<>"']/g,e)}function r(t,n){if(m(t))for(var o=0,e=t.length;e>o;o++)n.call(t,t[o],o,t);else for(o in t)n.call(t,t[o],o)}function a(t,n){var o=/(\/)[^\/]+\1\.\.\1/,e=("./"+t).replace(/[^\/]+$/,""),i=e+n;for(i=i.replace(/\/\.\//g,"/");i.match(o);)i=i.replace(o,"/");return i}function s(t,o){var e=n.get(t)||l({filename:t,name:"Render Error",message:"Template not found"});return o?e(o):e}function c(t,n){if("string"==typeof n){var o=n;n=function(){return new d(o)}}var e=u[t]=function(o){try{return new n(o,t)+""}catch(e){return l(e)()}};return e.prototype=n.prototype=f,e.toString=function(){return n+""},e}function l(t){var n="{Template Error}",o=t.stack||"";if(o)o=o.split("\n").slice(0,2).join("\n");else for(var e in t)o+="<"+e+">\n"+t[e]+"\n\n";return function(){return"object"==typeof console&&console.error(n+"\n\n"+o),n}}var u=n.cache={},d=this.String,p={"<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","&":"&#38;"},m=Array.isArray||function(t){return"[object Array]"==={}.toString.call(t)},f=n.utils={$helpers:{},$include:function(t,n,o){return t=a(o,t),s(t,n)},$string:o,$escape:i,$each:r},h=n.helpers=f.$helpers;n.get=function(t){return u[t.replace(/^\.\//,"")]},n.helper=function(t,n){h[t]=n},t.exports=n}()}]);